# 11. 프로덕션 레디 서비스 개발

- 서비스를 프로덕션에 배포할 수 있게 준비하려면 세가지 핵심 품질 속성이 보장되어야 한다.
  - 애플리케이션 보안
  - 서비스 구성성
  - 관측성

# 11.1 보안 서비스 개발

- 인증 : 애플리케이션에 접근하는 애플리케이션이나 사람의 신원을 확인
- 인가: 주체가 어떤 데이터에 어떤 작업을 요청하여 수행할 수 있는 권한이 있는지 확인
- 감사: 보안 이슈 탐지, 컴플라이언스 실행, 고객 지원을 위해 주체가 수행하는 작업 추적
- 보안 IPC: TLS

### 11.1.1 기존 모놀리식 애플리케이션의 보안

- (442p. 그림 11-1) ID/패스워드 방식 자격증명
- security context는 스레드 로컬에 사용자 정보 저장 (spring security)
- 역할에 따라 사용자를 인증
  - 사용자 종류마다 역할을 정의하고 스프링 시큐리티의 선언형 보안 메커니즘을 이용해 서비스 별 URL 접근을 제한
- 인-메모리 세션의 단점

### 11.1.2 마이크로서비스 아키텍처에서의 보안 구현

- 마이크로서비스 아키텍처는 모든 외부 여총을 API 게이트웨이와 하나 이상의 서비스가 처리하는 분산 시스템이다.
- 마이크로서비스 보안을 구현하려면 인증/인가 처리를 누가 담당할지부터 결정해야 한다.
- 인-메모리 보안 컨텍스트, 중앙화 세션은 통하지 않는다.
- API 게이트웨이 에서 인증 처리!
  - 각 서비스에서 인증 처리 하지 말고 API 게이트웨이에 위임 하자
- 인가 처리
  - 어떤 서비스 에이전트가 어떤 API를 호출 할 수 있나?
  - API 게이트웨이에서 구현? → API게이트웨이와 서비스가 강결합 된다. 또 URL 기반의 인가처리밖에 못한다 → 그냥 서비스에 구현
- JWT로 신원/역할 전달
  - 탈취? → 유효기간이 짧은 JWT를 발급 하는것 밖에 방법이 없다
- Oauth 2.0 응용

# 11.2 구성 가능한 서비스 설계

- 여러가지 구성 프로퍼티가 필요할 경우?
  - 프로퍼티의 값은 실행 환경마다 다르다.
  - 개발 / 운영
  - 하드코딩 ? 말도 안됨
- 자격증명 같은 민감한 데이터는 볼트나 파라미터 스토어에 저장해 놓는다.
- 런타임 프로퍼티 제공 모델
  - 푸시 모델 : 배포 인프라에서 서비스로 전달
  - 풀 모델 : 서비스 인스턴스가 구성 서버에 접속해서 읽어옴

### 11.2.1 푸시 기반의 외부화 구성

- 서비스 인스턴스가 생성될 때 프로퍼티 값을 제공
- CLI 인수
- OS 환경 변수
- JVM 시스템 프로퍼티
- 디렉터리 구성 파일
- 프로퍼티 명이 똑같을 경우 위 목록에서 앞선게 우선 적용 된다. (덮어 써진다)
- 푸시 기반은 이미 실행 중인 서비스를 재구성 하기는 어려운 한계가 있다.

### 11.2.2 풀 기반의 외부화 구성

- 서비스 인스턴스가 시동 시 자신이 필요한 값을 구성 전용 서버에 접속하여 읽는다.
- 중앙화 구성
- 민감한 데이터의 투명한 복호화
- 동적 재구성 : 폴링 으로 감지해서 자동 재구성

# 11.3 관측 가능한 서비스 설계

- 헬스 체크
- 로그 수집
- 분산 추적
- 예외 추적
- 애플리케이션 지표
- 감사 로깅

### 11.3.1 헬스체크 API 패턴

- 서비스 인스턴스는 자신이 요청을 처리할 수 있는 상태인지 여부를 배포 인프라에 알려야 한다.
- 액추에이터에는 관습 방식으로 서비스가 사용하는 인프라를 체크하는 실용적인 로직이 구현되어 있다. (test query, rabbit mq)

### 11.3.2 로그 수집 패턴

- 로그 수집 파이프라인을 통해 중앙 로깅 서버로 보내기 (462p. 그림 11-11)
- 로그 수집 인프라
  - ELK 스택

### 11.3.3 분산 추적 패턴

- 어떤 메소드가 느려진 원인을 찾자? 어떻게? MSA 환경에서 어디가 느린지 진단하고 트러블 슈팅하기가 어렵다.
- trace, span 등 이용
- X-B3-TraceId 이용
- 슬루스, 집킨이 지원

### 11.3.4 애플리케이션 지표 패턴

- CPU, 메모리 디스크 사용률 등 수집
- 마이크로미터 매트릭스가 지원
- 지표 수집도 풀 / 푸시 방식이 있다. 프로메테우스는 주기적 폴링을 통해 지표를 수집 한다. → 그라파나로 본다.

### 11.3.5 예외 추적 패턴

- 중복된 예외 제거, 알림을 생성, 예외 추적 서비스를 따로 두자!

### 11.3.6 감사 로깅 패턴

- 감사 로깅 코드를 비즈니스 로직에 추가

# 11.4 서비스 개발: 마이크로서비스 섀시 패턴

- 마이크로서비스 섀시는 횡단 관심사 처리에 특화된 프레임워크(들) 이다.
  - 외부화 구성
  - 헬스 체크
  - 애플리케이션 지표
  - 서비스 디스커버리
  - 회로 차단기
  - 분산 추적
- 서비스 매시
  - 섀시는 다양한 횡단 관심사를 구현하기 좋은 수단이지만, 사용하는 프로그래밍 언어마다 하나씩 필요하다는 문제점이 있다. 이런 문제점 때문에 공통 기능 일부를 서비스 메시에 구현하게 된 것.
